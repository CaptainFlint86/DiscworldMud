<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<muclient>
<plugin
   name="Horse_Tracker"
   author="Proeliator"
   id="1a51e592868f18f275a46619"
   language="Lua"
   purpose="Track the success/failure of horse usage"
   date_written="2022-11-21 10:05:30"
   save_state="y"
   requires="5.06"
   version="1.4"
   >
</plugin>

<!--  Aliases  -->
<aliases>
  <alias
   script="MyHorseStats"
   match="HorseStats"
   enabled="y"
   ignore_case="y"
   sequence="30"
  >
  </alias>
  <alias
   script="MyHorseStatsResetAll"
   match="HorseStatsReset"
   enabled="y"
   ignore_case="y"
   sequence="30"
  >
  </alias>
	  <alias
   script="MyHorseStatsResetHandler"
   match="HorseHandlerReset"
   enabled="y"
   ignore_case="y"
   sequence="30"
  >
  </alias>
	  <alias
   script="MyHorseStatsResetCharge"
   match="HorseChargeReset"
   enabled="y"
   ignore_case="y"
   sequence="30"
  >
  </alias>
</aliases>
-- Many Many Triggers
<!--  Triggers  -->
<triggers>
  <trigger
   enabled="y"
   keep_evaluating="y"
   match="You mount .+the .+horse."
   omit_from_output="n"
   sequence="18"
   regexp="y"
   script="HorseHandler"
   name="mountsuccess"
  >
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="You try to climb onto .+horse, but .+easily shakes you off and you land with a thump on the ground."
   omit_from_output="n"
   sequence="19"
   regexp="y"
   script="HorseHandler"
   name="mountfail"
  >
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="You .+ horse's pair of brown leather saddlebags."
   omit_from_output="n"
   sequence="20"
   regexp="y"
   script="HorseHandler"
   name="stashsuccess"
  >
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="You try to access .+ horse's saddlebag and promptly get kicked for your trouble."
   omit_from_output="n"
   sequence="21"
   regexp="y"
   script="HorseHandler"
   name="stashfail"
  >
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="You try to convince .+ horse to follow you, but .+ is having none of it."
   omit_from_output="n"
   sequence="22"
   regexp="y"
   script="HorseHandler"
   name="leadfail"
  >
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match=".+ horse starts to follow you."
   omit_from_output="n"
   sequence="23"
   regexp="y"
   script="HorseHandler"
   name="leadsuccess"
  >
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="You dress .+ horse with the"
   omit_from_output="n"
   sequence="23"
   regexp="y"
   script="HorseHandler"
   name="dresssuccess"
  >
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="You try to dress .+ horse with the "
   omit_from_output="n"
   sequence="23"
   regexp="y"
   script="HorseHandler"
   name="dressfail"
  >
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="You approach .+ horse, preparing to groom"
   omit_from_output="n"
   sequence="23"
   regexp="y"
   script="HorseHandler"
   name="groomsuccess"
  >
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="You pick out a brush and have a go at .+ horse's .+ with it"
   omit_from_output="n"
   sequence="23"
   regexp="y"
   script="HorseHandler"
   name="groomfail"
  >
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="You mess up the rhythm of your riding and are promptly tossed off .+ horse onto the ground."
   omit_from_output="n"
   sequence="24"
   regexp="y"
   script="HorseHandler"
   name="falloff"
  >
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match=".+ horse seems to get bored of following you and wanders off."
   omit_from_output="n"
   sequence="24"
   regexp="y"
   script="HorseHandler"
   name="wanderoff"
  >
  </trigger>	
	<trigger
   enabled="y"
   keep_evaluating="y"
   match="You tell .+ horse to take you to .+ and .+ starts off at a trot."
   omit_from_output="n"
   sequence="24"
   regexp="y"
   script="HorseHandler"
   name="ridesuccess"
  >
  </trigger>
	<trigger
   enabled="y"
   keep_evaluating="y"
   match="You tell .+ horse to take you to .+, but .+ seems unwilling to move."
   omit_from_output="n"
   sequence="24"
   regexp="y"
   script="HorseHandler"
   name="ridefail"
  >
  </trigger>	
	<trigger
   enabled="y"
   keep_evaluating="n"
   match="You hunch down over .+ horse and spur .+ into a (\w*) at the"
   omit_from_output="n"
   sequence="25"
   regexp="y"
   script="HorseChargeHandler"
   name="chargesuccess"
  >
  </trigger>
	<trigger
   enabled="y"
   keep_evaluating="n"
   match="You hunch down over .+ horse and try to spur .+ into a (\w*) at the"
   omit_from_output="n"
   sequence="26"
   regexp="y"
   script="HorseChargeHandler"
   name="chargefail"
  >
  </trigger>
</triggers>

<script>
<![CDATA[

-- load stats from mush (oh god, so many variables)
imountsuccess = tonumber(GetVariable("imountsuccess"))
imountfail = tonumber(GetVariable("imountfail"))
imountratio = GetVariable("imountratio")

istashsuccess = tonumber(GetVariable("istashsuccess"))
istashfail = tonumber(GetVariable("istashfail"))
istashratio = GetVariable("istashratio")

ileadsuccess = tonumber(GetVariable("ileadsuccess"))
ileadfail = tonumber(GetVariable("ileadfail"))
ileadratio = GetVariable("ileadratio")

idresssuccess = tonumber(GetVariable("idresssuccess"))
idressfail = tonumber(GetVariable("idressfail"))
idressratio = GetVariable("idressratio")

igroomsuccess = tonumber(GetVariable("igroomsuccess"))
igroomfail = tonumber(GetVariable("igroomfail"))
igroomratio = GetVariable("igroomratio")

iridesuccess = tonumber(GetVariable("iridesuccess"))
iridefail = tonumber(GetVariable("iridefail"))
irideratio = GetVariable("irideratio")

ifalloffsuccess = tonumber(GetVariable("ifalloffsuccess"))

iwanderoffsuccess = tonumber(GetVariable("iwanderoffsuccess"))

ichargesuccesswalk = tonumber(GetVariable("ichargesuccesswalk"))
ichargefailwalk = tonumber(GetVariable("ichargefailwalk"))
ichargewalkratio = GetVariable("ichargewalkratio")

ichargesuccesstrot = tonumber(GetVariable("ichargesuccesstrot"))
ichargefailtrot = tonumber(GetVariable("ichargefailtrot"))
ichargetrotratio = GetVariable("ichargetrotratio")

ichargesuccesscanter = tonumber(GetVariable("ichargesuccesscanter"))
ichargefailcanter = tonumber(GetVariable("ichargefailcanter"))
ichargecanterratio = GetVariable("ichargecanterratio")

ichargesuccess = tonumber(GetVariable("ichargesuccess"))
ichargefail = tonumber(GetVariable("ichargefail"))
ichargegallopratio = GetVariable("ichargegallopratio")

if (imountsuccess == nil) then imountsuccess = 0 end
if (imountfail == nil) then imountfail = 0 end
if (imountratio == nil) then imountratio = "-" end

if (istashsuccess == nil) then istashsuccess = 0 end
if (istashfail == nil) then istashfail = 0 end
if (istashratio == nil) then istashratio = "-" end

if (ileadsuccess == nil) then ileadsuccess = 0 end
if (ileadfail == nil) then ileadfail = 0 end
if (ileadratio == nil) then ileadratio = "-" end

if (idresssuccess == nil) then idresssuccess = 0 end
if (idressfail == nil) then idressfail = 0 end
if (idressratio == nil) then idressratio = "-" end

if (igroomsuccess == nil) then igroomsuccess = 0 end
if (igroomfail == nil) then igroomfail = 0 end
if (igroomratio == nil) then igroomratio = "-" end

if (iridesuccess == nil) then iridesuccess = 0 end
if (iridefail == nil) then iridefail = 0 end
if (irideratio == nil) then irideratio = "-" end

if (ifalloff == nil) then ifalloff = 0 end

if (iwanderoff == nil) then iwanderoff = 0 end

if (ichargesuccesswalk == nil) then ichargesuccesswalk = 0 end
if (ichargefailwalk == nil) then ichargefailwalk = 0 end
if (ichargewalkratio == nil) then ichargewalkratio = "-" end

if (ichargesuccesstrot == nil) then ichargesuccesstrot = 0 end
if (ichargefailtrot == nil) then ichargefailtrot = 0 end
if (ichargetrotratio == nil) then ichargetrotratio = "-" end

if (ichargesuccesscanter == nil) then ichargesuccesscanter = 0 end
if (ichargefailcanter == nil) then ichargefailcanter = 0 end
if (ichargecanterratio == nil) then ichargecanterratio = "-" end

if (ichargesuccessgallop == nil) then ichargesuccessgallop = 0 end
if (ichargefailgallop == nil) then ichargefailgallop = 0 end
if (ichargegallopratio == nil) then ichargegallopratio = "-" end

-- When Plugin is installed
function OnPluginInstall ()
ColourNote("orange","", "Horse tracker has been installed. Use 'HorseStats' to see statistics.")
ColourNote("orange","", "'HorseStatsReset' will reset all data.")
ColourNote("orange","", "'HorseHandlerReset' will reset handler data.")
ColourNote("orange","", "'HorseChargeReset' will reset charge data.")
end

-- Reset All Horse Statistics
function MyHorseStatsResetAll ()
DefaultHandlerValues ()
DefaultChargeValues ()
ColourNote("orange","", "Horse tracker has been reset")
end
-- Reset Only Handler Statistics
function MyHorseStatsResetHandler ()
DefaultHandlerValues ()
ColourNote("orange","", "Horse tracker Handler data has been reset")
end
-- Reset Only Charge Statistics
function MyHorseStatsResetCharge ()
DefaultChargeValues ()
ColourNote("orange","", "Horse tracker Charge data has been reset")
end

-- Our Default Values
	-- Handler Values
function DefaultHandlerValues ()
-- Mount
	imountsuccess = 0
	imountfail = 0
	imountratio = "-"
-- Stash/Retrieve
	istashsuccess = 0
	istashfail = 0
	istashratio = "-"
-- Lead
	ileadsuccess = 0
	ileadfail = 0
	ileadratio = "-"
-- Dress
	idresssuccess = 0
	idressfail = 0
	idressratio = "-"
-- Groom
	igroomsuccess = 0
	igroomfail = 0
	igroomratio = "-"
-- Ride
	iridesuccess = 0
	iridefail = 0
	irideratio = "-"
-- Fall Off
	ifalloff = 0
-- Wander Off
	iwanderoff = 0
end
	-- Charge Values
function DefaultChargeValues ()
-- Charge/Storm at a Walk
	ichargesuccesswalk = 0
	ichargefailwalk = 0
	ichargewalkratio = "-"
-- Charge/Storm at a Trot
	ichargesuccesstrot = 0
	ichargefailtrot = 0
	ichargetrotratio = "-"
-- Charge/Storm at a Canter
	ichargesuccesscanter = 0
	ichargefailcanter = 0
	ichargecanterratio = "-"
-- Charge/Storm at a Gallop
	ichargesuccessgallop = 0
	ichargefailgallop = 0
	ichargegallopratio = "-"
end

-- Function for Horse Handling
function HorseHandler (sName, sline, wildcards)
	s = string.gsub(sName,"success","")
	s = string.gsub(s,"fail","")

	_G['i' .. sName] = _G['i' .. sName] + 1

	if (string.match(sName, "success") or string.match(sName, "fail")) then
	_G['i' .. s .. 'ratio'] = tostring(bc.trunc(( _G['i'..s..'success'] /( _G['i'..s..'success'] + _G['i'..s..'fail'] ))*100)) .. "%"
	end
end

-- Function for Charge/Storm
function HorseChargeHandler (sName, sline, wildcards)
	_G['i'..sName .. wildcards[1]] = _G['i' .. sName .. wildcards[1]] + 1
	_G['icharge' .. wildcards[1] .. 'ratio'] = tostring(bc.trunc(( _G['ichargesuccess' .. wildcards[1]] /( _G['ichargesuccess' .. wildcards[1]] + _G['ichargefail' .. wildcards[1]] ))*100)) .. "%"
end

-- Messages sent to the Mud
function MyHorseStats ()
    ColourNote("orange","", "Mount:          Success: " .. imountsuccess .. "\tFail: ".. imountfail .. "\t\t(" .. imountratio .. ")")
    ColourNote("orange","", "Stash/Retrieve: Success: " .. istashsuccess .. "\tFail: ".. istashfail .. "\t\t(" .. istashratio .. ")")
    ColourNote("orange","", "Lead:           Success: " .. ileadsuccess .. "\tFail: ".. ileadfail .. "\t\t(" .. ileadratio .. ")")
    ColourNote("orange","", "Groom:          Success: " .. igroomsuccess .. "\tFail: ".. igroomfail .. "\t\t(" .. igroomratio .. ")")
    ColourNote("orange","", "Dress:          Success: " .. idresssuccess .. "\tFail: ".. idressfail .. "\t\t(" .. idressratio .. ")")
    ColourNote("orange","", "Riding:         Success: " .. iridesuccess .. "\tFail: ".. iridefail .. "\t\t(" .. irideratio .. ")")
    ColourNote("orange","", "You have fallen off " .. ifalloff .. " times")
    ColourNote("orange","", "Your horse has wandered off " .. iwanderoff .. " times")
    ColourNote("orange","", "Charge/Storm")
    ColourNote("orange","", "Walk:           Success: " .. ichargesuccesswalk .. "\tFail: ".. ichargefailwalk .. "\t\t(" .. ichargewalkratio .. ")")
    ColourNote("orange","", "Trot:           Success: " .. ichargesuccesstrot .. "\tFail: ".. ichargefailtrot .. "\t\t(" .. ichargetrotratio .. ")")
    ColourNote("orange","", "Canter:         Success: " .. ichargesuccesscanter .. "\tFail: ".. ichargefailcanter .. "\t\t(" .. ichargecanterratio .. ")")
    ColourNote("orange","", "Gallop:         Success: " .. ichargesuccessgallop .. "\tFail: ".. ichargefailgallop .. "\t\t(" .. ichargegallopratio .. ")")
end


-- Save variables when session closed
function OnPluginClose ()
    SetVariable("imountsuccess", tostring(imountsuccess))
    SetVariable("imountfail", tostring(imountfail))
    SetVariable("imountratio", tostring(imountratio))

    SetVariable("istashsuccess", tostring(istashsuccess))
    SetVariable("istashfail", tostring(istashfail))
    SetVariable("istashratio", tostring(istashratio))

    SetVariable("ileadsuccess", tostring(ileadsuccess))
    SetVariable("ileadfail", tostring(ileadfail))
    SetVariable("ileadratio", tostring(ileadratio))

    SetVariable("idresssuccess", tostring(idresssuccess))
    SetVariable("idressfail", tostring(idressfail))
    SetVariable("idressratio", tostring(idressratio))

    SetVariable("igroomsuccess", tostring(igroomsuccess))
    SetVariable("igroomfail", tostring(igroomfail))
    SetVariable("igroomratio", tostring(igroomratio))

    SetVariable("iridesuccess", tostring(iridesuccess))
    SetVariable("iridefail", tostring(iridefail))
    SetVariable("irideratio", tostring(irideratio))

    SetVariable("ifalloff", tostring(ifalloff))

    SetVariable("iwanderoff", tostring(iwanderoff))

    SetVariable("ichargesuccesswalk", tostring(ichargesuccesswalk))
    SetVariable("ichargefailwalk", tostring(ichargefailwalk))
    SetVariable("ichargewalkratio", tostring(ichargewalkratio))

    SetVariable("ichargesuccesstrot", tostring(ichargesuccesstrot))
    SetVariable("ichargefailtrot", tostring(ichargefailtrot))
    SetVariable("ichargetrotratio", tostring(ichargetrotratio))

    SetVariable("ichargesuccesscanter", tostring(ichargesuccesscanter))
    SetVariable("ichargefailcanter", tostring(ichargefailcanter))
    SetVariable("ichargecanterratio", tostring(ichargecanterratio))

    SetVariable("ichargesuccessgallop", tostring(ichargesuccessgallop))
    SetVariable("ichargefailgallop", tostring(ichargefailgallop))
    SetVariable("ichargegallopratio", tostring(ichargegallopratio))
end
]]>
</script> 
</muclient>
