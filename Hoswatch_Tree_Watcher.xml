<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<muclient>
<plugin
   name="Hogswatch_Tree_Watcher"
   id="3732d581569f30eb5fcc35f4"
   language="Lua"
   purpose="Track drops and spawn windows for the Hogswatch Tree"
   author="Proeliator"
   date_written="2023-12-14"
   save_state="y"
   requires="5.06"
   version="3.1"
>
</plugin>

<aliases>
  <alias script="HogswatchHelp" match="^Hogswatch Help$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="HogswatchStats" match="^Hogswatch Stats$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="HogswatchTop" match="^Hogswatch Stats Top$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="MyHogswatchStats" match="^My Hogswatch Stats$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="HogswatchBreads" match="^Hogswatch Breads$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="HogswatchChecklist" match="^Hogswatch Checklist$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="CheckNewItems" match="^Hogswatch New$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="HogswatchSpawn" match="^Hogswatch Spawn$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="HogswatchClear" match="^Hogswatch Clear$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="HogswatchConfirm" match="^Hogswatch Confirm$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="HogswatchNewClear" match="^Hogswatch Clear New$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="UpdateSnapshot" match="^Hogswatch Update$" enabled="y" regexp="y" ignore_case="y" />
  <alias script="HogswatchRemove" match="^Hogswatch Remove (.*)$" enabled="y" regexp="y" ignore_case="y" />
</aliases>

<triggers>
  <trigger enabled="y" regexp="y" script="GetPresent" name="PresentGrabbed" sequence="18"
   match="^(?:> )?(?:[^([])(?:.[^:]+) (?:grabs|grab) (?<pronoun>his|her|its|your) present from the huge box and (?:tears|tear) off the paper revealing (?<present>[^.]+)\.(?<humbug>  Oh, and what's that - a humbug\?)?(?:  There's nice\.)?$" />
  
  <trigger enabled="y" regexp="y" script="GetPresent" name="PresentOnFloor" sequence="18"
   match="^(?:> )?(?:[^([])(?:.[^:]+) (?:grabs|grab) (?<pronoun>his|her|its|your) present from the huge box and (?:tears|tear) off the paper, but somehow (?<present>.+) ends up on the floor instead\.$" />

  <trigger enabled="y" regexp="y" script="TreeStatus" name="TreeUp" sequence="18"
   match="^The warehouse foreman dusts off his hands and glares at everyone before departing, muttering about bloody vandals ruining Hogswatch AGAIN.$" />

  <trigger enabled="y" regexp="y" script="TreeStatus" name="TreeDown" sequence="18"
   match="^The enraged Hogswatch tree has been defeated!$" />
</triggers>

<script>
<![CDATA[
require "serialize"

-- Tables & Saved Vars
hogswatchtable = hogswatchtable or {}
currenthogswatchtable = currenthogswatchtable or {}
personalhogswatchtable = personalhogswatchtable or {}
hogswatchstatstable = hogswatchstatstable or {}
hogswatchbreadtable = hogswatchbreadtable or {}
last_seen_snapshot = last_seen_snapshot or {}
last_defeat_time = last_defeat_time or 0

-- Configuration
local confirm_clear = false
local adjectives = {"brown", "white", "crusty", "rustic", "wholemeal"}
local breadtypes = {"bap", "barm", "barm cake", "batch", "bread bun", "bread roll", "sto muffin", "teacake"}

-- Average Spawn Window (in seconds)
local min_spawn = 3300 -- 55 minutes
local max_spawn = 3900 -- 65 minutes

function OnPluginInstall()
    local vars = {"hogswatchtable", "currenthogswatchtable", "personalhogswatchtable", "hogswatchstatstable", "hogswatchbreadtable", "last_seen_snapshot", "last_defeat_time"}
    for _, v in ipairs(vars) do
        local str = GetVariable(v)
        if str and str ~= "" then 
            local status, err = pcall(loadstring(str))
            if not status then Note("Error loading " .. v .. ": " .. err) end
        end
    end
    Note("Hogswatch Watcher V3.1 Ready. Type 'Hogswatch Help' for commands.")
end

-- --- Helpers ---
local function formatTime(seconds)
    if seconds <= 0 then return "Nowish" end
    local mins = math.floor(seconds / 60)
    local secs = seconds % 60
    if mins >= 60 then
        return string.format("%dh %dm", math.floor(mins/60), mins%60)
    end
    return string.format("%dm %ds", mins, secs)
end

-- --- Commands ---
function HogswatchHelp()
    ColourNote("silver", "black", "\n" .. string.rep("-", 65))
    ColourNote("green", "black", " Hogswatch Tree Watcher V3.1 - Commands")
    ColourNote("silver", "black", string.rep("-", 65))
    
    local cmds = {
        {"--- Tracking ---", ""},
        {"Hogswatch Stats", "Show results for last fight and global totals."},
        {"My Hogswatch Stats", "Show only items you personally opened."},
        {"Hogswatch Stats Top", "Display the top 5 rarest drops overall."},
        {"Hogswatch Breads", "List all specific breakfast rolls found."},
        {"Hogswatch Checklist", "Show which rolls you are still missing."},
        
        {"--- Utility & Timers ---", ""},
        {"Hogswatch Spawn", "Check time since last defeat and spawn estimate."},
        {"Hogswatch New", "Show items found since your last snapshot."},
        {"Hogswatch Remove <item>", "Delete a fake/mis-parsed item from lists."},
        
        {"--- Maintenance ---", ""},
        {"Hogswatch Clear New", "Mark all current items as 'known' (clears New list)."},
        {"Hogswatch Update", "Manually update the 'known items' snapshot."},
        {"Hogswatch Clear", "Wipe all tracking data (requires confirmation)."}
    }
    
    for _, cmd in ipairs(cmds) do
        if cmd[2] == "" then
            ColourNote("cyan", "black", "\n " .. cmd[1])
        else
            ColourNote("yellow", "black", string.format(" %-22s ", cmd[1]))
            ColourNote("silver", "black", "- " .. cmd[2])
        end
    end
    ColourNote("silver", "black", "\n" .. string.rep("-", 65) .. "\n")
end

function HogswatchSpawn()
    if last_defeat_time == 0 then
        ColourNote("orange", "", "No defeat recorded yet.")
        return
    end
    local elapsed = os.time() - last_defeat_time
    local window_start = math.max(0, min_spawn - elapsed)
    local window_end = math.max(0, max_spawn - elapsed)

    ColourNote("silver", "black", "\n" .. string.rep("-", 40))
    ColourNote("green", "black", " Hogswatch Spawn Tracker")
    ColourNote("silver", "black", string.rep("-", 40))
    ColourNote("yellow", "", "Last Defeated: " .. os.date("%H:%M:%S", last_defeat_time))
    ColourNote("yellow", "", "Time Elapsed : " .. formatTime(elapsed))
    
    if elapsed > max_spawn then
        ColourNote("red", "", "Status       : Tree is OVERDUE for spawn!")
    elseif elapsed > min_spawn then
        ColourNote("cyan", "", "Status       : Inside spawn window! (Ends in ~" .. formatTime(window_end) .. ")")
    else
        ColourNote("silver", "", "Next Window  : In " .. formatTime(window_start) .. " to " .. formatTime(window_end))
    end
    ColourNote("silver", "black", string.rep("-", 40) .. "\n")
end

function HogswatchRemove(sName, sLine, wildcards)
    local target = wildcards[1]:match("^%s*(.-)%s*$")
    local tables_to_check = {hogswatchtable, currenthogswatchtable, personalhogswatchtable, hogswatchbreadtable}
    local removed = false

    for _, t in ipairs(tables_to_check) do
        if t[target] then
            t[target] = t[target] - 1
            if t[target] <= 0 then t[target] = nil end
            removed = true
        end
    end

    if removed then
        ColourNote("cyan", "", "Removed one instance of: " .. target)
    else
        ColourNote("red", "", "Item '" .. target .. "' not found in any tracking tables.")
    end
end

-- --- Logic ---
function GetPresent(sName, sLine, wildcards)
    local present = wildcards.present:match("^%s*(.-)%s*$")
    local isYourPresent = (wildcards.pronoun == "your")
    local function record(item)
        local displayName = item
        local isRoll = false
        local lowItem = item:lower()
        for _, adj in ipairs(adjectives) do
            if lowItem:find(adj) then
                for _, brd in ipairs(breadtypes) do
                    if lowItem:find(brd) then isRoll = true break end
                end
            end
        end
        if isRoll then
            hogswatchbreadtable[item] = (hogswatchbreadtable[item] or 0) + 1
            displayName = "a breakfast roll"
        end
        hogswatchtable[displayName] = (hogswatchtable[displayName] or 0) + 1
        currenthogswatchtable[displayName] = (currenthogswatchtable[displayName] or 0) + 1
        if isYourPresent then personalhogswatchtable[displayName] = (personalhogswatchtable[displayName] or 0) + 1 end
    end
    record(present)
    if wildcards.humbug and wildcards.humbug:find("humbug") then record("a humbug") end
end

function TreeStatus(sName, sLine, wildcards)
    if sName == "TreeDown" then
        last_defeat_time = os.time()
        for k in pairs(currenthogswatchtable) do currenthogswatchtable[k] = nil end
        hogswatchstatstable["Defeated"] = (hogswatchstatstable["Defeated"] or 0) + 1
        ColourNote("yellow", "", "Fight data reset. Defeat recorded at " .. os.date("%H:%M:%S"))
    else
        ColourNote("orange", "", "Hogswatch Tree Spawned!")
    end
end

-- --- Displays ---
function ShowStats(title, t)
    local total = 0
    for _, v in pairs(t) do total = total + v end
    if total == 0 then return end
    ColourNote("green", "", "\n" .. title)
    local sorted = {}
    for k, v in pairs(t) do table.insert(sorted, {name = k, count = v}) end
    table.sort(sorted, function(a, b) return a.count > b.count end)
    for _, item in ipairs(sorted) do
        ColourNote("orange", "", string.format("%-30s: %-3d (%.1f%%)", item.name, item.count, (item.count/total)*100))
    end
end

function HogswatchStats()
    ShowStats("--- LAST FIGHT ---", currenthogswatchtable)
    ShowStats("--- GLOBAL TOTALS ---", hogswatchtable)
    ColourNote("green", "", "Total Trees Defeated: " .. (hogswatchstatstable["Defeated"] or 0))
end

function MyHogswatchStats() ShowStats("--- YOUR PERSONAL STATS ---", personalhogswatchtable) end
function HogswatchBreads() ShowStats("--- BREAKFAST ROLL VARIETIES ---", hogswatchbreadtable) end

function HogswatchChecklist()
    local foundCount = 0
    local totalPossible = #adjectives * #breadtypes
    ColourNote("cyan", "", "\n--- BREAKFAST ROLL CHECKLIST ---")
    for _, adj in ipairs(adjectives) do
        for _, brd in ipairs(breadtypes) do
            local fullName = "a " .. adj .. " " .. brd
            if hogswatchbreadtable[fullName] then
                foundCount = foundCount + 1
                ColourNote("silver", "", "[X] " .. fullName)
            else
                ColourNote("red", "", "[ ] " .. fullName)
            end
        end
    end
    ColourNote("green", "", string.format("\nCollection Progress: %d/%d (%.1f%%)", foundCount, totalPossible, (foundCount/totalPossible)*100))
end

function HogswatchTop()
    local sorted = {}
    for k, v in pairs(hogswatchtable) do table.insert(sorted, {name = k, count = v}) end
    table.sort(sorted, function(a, b) return a.count > b.count end)
    ColourNote("cyan", "", "\n--- TOP 5 RARITY ---")
    for i = 1, math.min(5, #sorted) do
        ColourNote("yellow", "", string.format("%d. %-25s %d", i, sorted[i].name, sorted[i].count))
    end
end

function CheckNewItems()
    local found = false
    ColourNote("cyan", "", "\n--- NEW ITEMS ---")
    for item, count in pairs(hogswatchtable) do
        local old = last_seen_snapshot[item] or 0
        if count > old then
            found = true
            ColourNote("yellow", "", string.format("NEW: %-25s (+%d) Total: %d", item, count - old, count))
        end
    end
    if not found then Note("No new items.") end
end

function UpdateSnapshot()
    last_seen_snapshot = {}
    for k, v in pairs(hogswatchtable) do last_seen_snapshot[k] = v end
    ColourNote("silver", "", "Snapshot updated.")
end

function HogswatchNewClear() UpdateSnapshot() ColourNote("yellow", "", "New list cleared.") end

function HogswatchClear()
    confirm_clear = true
    ColourNote("red", "", "DANGER: Wiping tracking data. Type 'Hogswatch Confirm' within 10s.")
    DoAfterSpecial(10, "confirm_clear = false", 12)
end

function HogswatchConfirm()
    if confirm_clear then
        hogswatchtable, currenthogswatchtable, personalhogswatchtable, hogswatchstatstable, hogswatchbreadtable, last_defeat_time = {}, {}, {}, {}, {}, 0
        confirm_clear = false
        ColourNote("red", "", "All Data Wiped.")
    end
end

function OnPluginClose()
    local vars = {"hogswatchtable", "personalhogswatchtable", "currenthogswatchtable", "hogswatchstatstable", "hogswatchbreadtable", "last_seen_snapshot", "last_defeat_time"}
    for _, v in ipairs(vars) do
        SetVariable(v, v .. " = " .. serialize.save_simple(_G[v]))
    end
end
]]>
</script>
</muclient>